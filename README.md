# stat-IDE v1 - 经典统计模块

一个基于 Python + Streamlit 的本地统计分析 Web 应用，集成本地 Ollama 模型（phi3-mini）作为统计辅导 AI 助手。

## 应用领域模块

stat-IDE 按照药物研发流程和生物医学应用阶段，将统计分析功能划分为以下模块：

### 模块设计理念

按照**使用频率**和**应用阶段**的逻辑顺序排列：

1. **📊 经典统计** → 通用统计方法（最常用，贯穿所有阶段）✅ **当前版本**
2. **🧬 组学分析** → 靶点发现与验证（基础研究阶段）⚠️ **开发中**
3. **💊 PK/PD & 毒理** → 临床前研究（药物开发阶段）⚠️ **开发中**
4. **⏱️ 生存分析** → 临床试验结果分析（临床阶段）⚠️ **开发中**
5. **📚 Meta分析** → 证据综合（后市场/系统综述阶段）⚠️ **计划中**

### 1. 📊 经典统计（当前版本）✅

**研发阶段：** 通用方法 → 贯穿所有阶段

**应用场景：**
- 临床试验数据分析
- 基础医学研究
- 流行病学研究
- 一般生物医学数据分析
- 描述性统计分析

**已实现方法：**
- 两组比较（t检验、Mann-Whitney U检验）
- 多组比较（单因素ANOVA）
- 相关性分析（Pearson、Spearman）
- 简单线性回归

**开发中的方法：**
- 单样本检验（单样本t检验、单样本Wilcoxon检验）
- 配对样本检验（配对样本t检验、配对样本Wilcoxon检验）
- 分类数据检验（卡方检验、Fisher精确检验、McNemar检验）
- 非参数多组比较（Kruskal-Wallis检验、Friedman检验）
- 回归分析扩展（多元线性回归、逻辑回归、多项式回归）
- 方差分析扩展（双因素ANOVA、重复测量ANOVA、ANCOVA、混合效应模型）
- 其他方法（Kendall's tau、偏相关分析、中介效应分析）

### 2. 🧬 组学分析（开发中）⚠️

**研发阶段：** 基础研究 → 靶点发现与验证

**应用场景：**
- 基因组学数据分析（GWAS、变异分析）
- 转录组学（RNA-seq）差异表达分析
- 蛋白质组学分析
- 代谢组学分析
- 多组学数据整合与靶点选择
- 生物标志物发现

**计划包含方法：**
- 差异表达分析（DESeq2、edgeR）
- 富集分析（GO、KEGG、Reactome）
- 聚类分析（层次聚类、K-means）
- 主成分分析（PCA）
- 多组学数据关联分析
- 网络分析（PPI、共表达网络）

### 3. 💊 PK/PD & 毒理（开发中）⚠️

**研发阶段：** 临床前研究 → 药物开发

**应用场景：**
- 药代动力学（Pharmacokinetics, PK）分析
- 药效动力学（Pharmacodynamics, PD）分析
- 毒理学研究
- 药物剂量-效应关系
- 药物安全性评估
- 临床前药效学评价

**计划包含方法：**
- 房室模型拟合（一室、二室、三室模型）
- 药代动力学参数估计（Cmax、Tmax、AUC、t1/2等）
- 剂量-效应曲线（Emax模型、Hill方程）
- 毒理学剂量-反应分析（LD50、NOAEL）
- 安全性边界分析
- 药物相互作用分析

### 4. ⏱️ 生存分析（开发中）⚠️

**研发阶段：** 临床试验 → 临床结果分析

**应用场景：**
- 临床试验的生存时间分析
- 疾病预后研究
- 药物疗效评估（OS、PFS、DFS）
- 复发时间分析
- 无进展生存期（PFS）分析
- 总生存期（OS）分析

**计划包含方法：**
- Kaplan-Meier 生存曲线
- Log-rank 检验
- Cox 比例风险回归
- 风险比（HR）估计
- 中位生存时间估计
- 分层分析

### 5. 📚 Meta分析（计划中）❌

**研发阶段：** 证据综合 → 系统综述与荟萃分析

**应用场景：**
- 系统综述（Systematic Review）
- 荟萃分析（Meta-analysis）
- 证据综合与评估
- 多中心研究数据整合
- 发表偏倚评估

**计划包含方法：**
- 固定效应模型
- 随机效应模型
- 异质性检验（I²、Q统计量）
- 森林图（Forest Plot）
- 漏斗图（Funnel Plot）
- 敏感性分析
- 亚组分析

### 模块覆盖评估

**当前覆盖情况：**

- ✅ **已实现**：经典统计（基础方法）
- ⚠️ **开发中**：组学分析、PK/PD & 毒理、生存分析
- ❌ **计划中**：Meta分析

**是否需要经济统计模块？**

- **药物经济学**：可考虑作为 PK/PD & 毒理模块的子模块，或单独模块
- **一般经济统计**：不属于生物医学统计范畴，不建议包含
- **建议**：如需要，可添加"药物经济学"子模块，包含成本-效果分析、成本-效用分析等

**模块顺序说明：**

按照**使用频率**和**应用阶段**的逻辑顺序：
1. **经典统计**：最常用，通用工具（贯穿全程）✅
2. **组学分析**：靶点发现（基础研究阶段）⚠️
3. **PK/PD & 毒理**：临床前验证（药物开发阶段）⚠️
4. **生存分析**：临床试验结果（临床阶段）⚠️
5. **Meta分析**：证据综合（后期/后市场）❌

**模块说明：**
- 每个模块都有详细的说明和帮助提示（通过"?"图标或展开面板）
- 开发中的模块会显示"⚠️ 正在开发中"提示
- 经典统计模块列出了所有已实现和计划中的方法

## 功能特性

- 📊 **经典统计分析**：支持两组比较、多组比较、相关性分析、简单线性回归
- 🤖 **AI 统计辅导**：基于本地 phi3-mini 模型，提供统计问题解答
- 📈 **可视化展示**：自动生成箱线图、散点图、回归图等
- 📁 **CSV 数据上传**：支持本地 CSV 文件上传和分析

## 环境要求

- Python 3.8+
- Ollama 已安装并运行
- phi3-mini 模型已下载

## 安装步骤

### 1. 创建虚拟环境

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 确认 Ollama 运行状态

确保 Ollama 服务正在运行：

```bash
# 检查 Ollama 是否运行
ollama list

# 如果未安装，请访问 https://ollama.ai 下载安装
# 如果未下载 phi3-mini 模型，运行：
ollama pull phi3:mini
```

### 4. 生成模拟数据（可选）

```bash
python simulate_data.py
```

这将在 `data/` 目录下生成多个测试用的 CSV 文件。

## 启动应用

```bash
streamlit run app.py
```

应用将在浏览器中自动打开，默认地址：http://localhost:8501

## 部署说明

### Streamlit Community Cloud（推荐用于社区和个人项目）

Streamlit Community Cloud 是 Streamlit 官方提供的免费部署平台，适合个人学习和社区项目。

**特点：**

- ✅ 完全免费，适合个人爱好和学习
- ✅ 可部署无限数量的公开应用
- ✅ 探索和学习 Streamlit 社区和热门应用
- ✅ 简单易用，一键部署

**部署步骤：**

1. 将代码推送到 GitHub 仓库
2. 访问 [Streamlit Community Cloud](https://share.streamlit.io/)
3. 使用 GitHub 账号登录
4. 选择你的仓库和主文件（`app.py`）
5. 点击 "Deploy" 即可自动部署

**访问方式：**

- ✅ **公开访问**：部署后，应用会获得一个公开的 URL（如：`https://your-app-name.streamlit.app`）
- ✅ **无需登录**：第三方用户可以直接通过 URL 访问和使用应用，无需注册账号
- ✅ **SaaS 模式**：应用以 SaaS（软件即服务）形式提供，用户通过浏览器即可使用
- ✅ **即时可用**：部署完成后，任何人都可以立即访问和试用

**注意事项：**

- ⚠️ **数据隐私**：由于应用是公开的，上传的数据对所有访问者可见，请勿上传敏感数据
- ⚠️ **AI 功能限制**：Ollama 服务需要在本地运行，部署到 Streamlit Cloud 后，AI 功能可能无法使用（除非配置远程 Ollama 服务）
- ⚠️ **资源限制**：免费版有资源使用限制，适合演示和小规模使用
- ⚠️ **依赖管理**：需要确保 `requirements.txt` 包含所有依赖，且所有依赖都可在云端安装

### Snowflake（企业级部署）

Snowflake 提供企业级的 Streamlit 部署服务，适合商业和生产环境。

**特点：**

- ✅ 企业级安全、支持和完全托管的基础设施
- ✅ 可部署无限数量的私有应用，支持基于角色的共享
- ✅ 与 Snowflake 完整数据栈集成
- ✅ 专业的技术支持

**适用场景：**

- 企业内部数据分析工具
- 需要数据安全和访问控制的应用
- 需要与 Snowflake 数据仓库集成的应用

### 其他平台（自定义部署）

如果你需要在自有硬件或云服务上部署，可以使用以下方式：

**特点：**

- ✅ 在自己的硬件或云服务上部署
- ✅ 自行设置和维护身份验证、资源和成本
- ✅ 完全控制部署环境

**常见部署方式：**

1. **Docker 部署**

   ```bash
   # 构建 Docker 镜像
   docker build -t stat-ide .
   
   # 运行容器
   docker run -p 8501:8501 stat-ide
   ```

2. **云服务器部署（AWS、Azure、GCP等）**

   - 在云服务器上安装 Python 和依赖
   - 使用 systemd 或 supervisor 管理进程
   - 配置反向代理（Nginx）和 SSL 证书

3. **使用 Streamlit 的 Docker 镜像**

   ```bash
   docker run -p 8501:8501 -v $(pwd):/app streamlit run app.py
   ```

**注意事项：**

- 需要自行配置身份验证（如 Streamlit 的密码保护）
- 需要管理服务器资源和成本
- 建议使用进程管理器确保应用持续运行

## 使用流程

### 1. 上传数据

- 在左侧栏点击"上传 CSV 文件"
- 选择包含数值变量和分组变量的 CSV 文件
- 系统会自动识别数值型和分类型列

### 2. 选择统计任务

- **两组比较**：适用于比较两个组间的差异（t 检验 / Mann-Whitney）
- **多组比较**：适用于比较多个组间的差异（单因素 ANOVA）
- **相关性分析**：分析两个数值变量间的相关关系
- **简单线性回归**：建立因变量与自变量的线性关系

### 3. 设置参数

- 选择因变量和分组变量（或自变量）
- 调整显著性水平 α（默认 0.05）
- 选择是否进行正态性检验

### 4. 执行分析

- 点击"🚀 执行分析"按钮
- 查看图形展示区的可视化结果
- 查看统计结果区的检验统计量、p 值和解释

### 5. 咨询 AI 助手

- 在右侧 AI 聊天区输入统计相关问题
- 例如："这个 t 检验的结果如何解释？"
- AI 会基于当前分析结果提供解答
- **注意**：AI 仅回答统计相关问题，其他问题会被拒绝

## 文件结构

```
stat-IDE-v1/
├── app.py                 # Streamlit 主程序
├── stats_core.py          # 经典统计分析函数
├── ollama_client.py       # Ollama 通信封装
├── simulate_data.py       # 模拟数据生成脚本
├── requirements.txt       # 依赖列表
├── README.md             # 使用说明
└── data/                 # 数据目录（运行 simulate_data.py 后生成）
    ├── two_groups_normal.csv
    ├── two_groups_nonnormal.csv
    ├── anova_three_groups.csv
    ├── correlation_linear.csv
    ├── regression_simple.csv
    └── mixed_data.csv
```

## 统计方法说明

### 已实现的统计方法

#### 1. 两组比较（独立样本）

- **自动选择检验方法**：
  - 如果两组都近似正态且方差齐：使用独立样本 t 检验
  - 如果两组都近似正态但方差不齐：使用 Welch's t 检验
  - 否则：使用 Mann-Whitney U 检验（非参数）
- **提供指标**：效应量（Cohen's d 或 r）、描述性统计、正态性和方差齐性检验结果

#### 2. 多组比较（单因素 ANOVA）

- 使用单因素方差分析（One-way ANOVA）
- 提供效应量（eta-squared）
- 自动进行事后检验（Tukey HSD）以确定具体组间差异
- 提供组间和组内平方和、均方等详细信息

#### 3. 相关性分析

- **自动选择方法**：
  - 如果两个变量都近似正态：使用 Pearson 相关系数
  - 否则：使用 Spearman 等级相关系数
- **提供指标**：相关系数、p值、95%置信区间（Pearson）、相关性强度解释

#### 4. 简单线性回归

- 使用普通最小二乘法（OLS）
- 提供回归系数、R²、调整R²、置信区间、F统计量等
- 提供残差标准误、斜率标准误等诊断信息

### 尚未实现的经典统计方法

以下方法在经典统计中较为常见，但当前版本尚未实现：

#### 单样本检验

- ❌ **单样本t检验**：与理论值或已知总体均值比较
- ❌ **单样本Wilcoxon符号秩检验**：单样本非参数检验

#### 配对样本检验

- ❌ **配对样本t检验**：配对设计的两组比较（如治疗前后）
- ❌ **配对样本Wilcoxon符号秩检验**：配对设计的非参数检验

#### 分类变量分析

- ❌ **卡方检验**：分类变量的关联性检验（2×2表、R×C表）
- ❌ **Fisher精确检验**：小样本的2×2表检验
- ❌ **McNemar检验**：配对分类数据的检验

#### 多组非参数检验

- ❌ **Kruskal-Wallis检验**：多组比较的非参数方法（ANOVA的非参数替代）

#### 多元回归分析

- ❌ **多元线性回归**：多个自变量的线性回归
- ❌ **逻辑回归**：二分类因变量的回归分析
- ❌ **多项式回归**：非线性关系的回归

#### 高级方差分析

- ❌ **双因素ANOVA**：两个分组变量的方差分析
- ❌ **重复测量ANOVA**：同一受试者的重复测量
- ❌ **协方差分析（ANCOVA）**：控制协变量的方差分析

#### 其他方法

- ❌ **描述性统计模块**：虽然结果中包含描述性统计，但缺少独立的描述性统计模块
- ❌ **正态性检验模块**：虽然自动进行，但缺少独立的检验模块
- ❌ **功效分析**：样本量计算和检验功效评估

### 方法覆盖评估

**当前覆盖度：约 40-50%**

- ✅ **已覆盖**：独立样本比较、单因素多组比较、相关性分析、简单回归
- ⚠️ **部分覆盖**：非参数检验（仅Mann-Whitney）、方差分析（仅单因素）
- ❌ **未覆盖**：配对设计、分类变量分析、多元分析、高级ANOVA

**建议优先级（如要扩展）：**

1. **高优先级**：配对样本t检验、卡方检验（最常用）
2. **中优先级**：多元线性回归、双因素ANOVA
3. **低优先级**：重复测量ANOVA、协方差分析、逻辑回归

## 注意事项

1. **Ollama 服务**：确保 Ollama 在后台运行，否则 AI 功能无法使用
2. **数据格式**：CSV 文件应包含明确的列名，数值变量为数字类型
3. **样本量**：建议每组至少 3 个观测值，以获得可靠的统计结果
4. **AI 限制**：AI 助手仅回答统计相关问题，其他问题会被拒绝

## 故障排除

### Ollama 连接失败

- 检查 Ollama 是否运行：`ollama list`
- 确认模型已下载：`ollama pull phi3:mini`
- 检查端口 11434 是否被占用

### 数据读取错误

- 确保 CSV 文件编码为 UTF-8
- 检查列名是否包含特殊字符
- 确保数值列不包含非数字字符

### 统计检验报错

- 检查数据是否包含缺失值
- 确认分组变量组数符合要求（两组比较需要恰好 2 个组）
- 确保每组有足够的观测值

## 后续计划

- [ ] 生存分析模块
- [ ] 组学分析模块
- [ ] PK/PD & 毒理模块
- [ ] 更多统计方法支持
- [ ] 导出报告功能

## 许可证

本项目仅供学习和研究使用。
